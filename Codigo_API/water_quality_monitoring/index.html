<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel – Monitoreo de Calidad de Agua</title>
  <!-- Bootstrap para estilos rápidos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Chart.js para gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- jsPDF para exportar la gráfica a PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body{background:#181630;color:#e8eef7}
    .navbar,.card{background:#157eab;border:none}
    .form-label{margin-top:.5rem}
    .btn-primary{background:#2d6cdf;border:none}
    .btn-outline-light{border-color:#87a0c4;color:#e8eef7}
    a{color:#94b9ff}
    .table thead th{color:#9fb8dd}
    .table{color:#e8eef7}
    canvas{background:#0e1d33;border-radius:.5rem}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark px-3">
    <span class="navbar-brand fw-bold">Monitoreo de Agua</span>
    <div class="ms-auto small">Frontend conectado a tu API Flask</div>
  </nav>

  <div class="container my-4">
    <!-- Configuración de API -->
    <div class="alert alert-info bg-opacity-10 border-0 text-light" role="alert">
      <strong>URL de la API:</strong>
      <input id="apiBase" class="form-control d-inline-block w-auto ms-2" value="" placeholder="(vacío = mismo origen)" />
      <button class="btn btn-sm btn-outline-light ms-2" onclick="testAPI()">Probar conexión</button>
      <span id="apiStatus" class="ms-3"></span>
    </div>

    <div class="row g-4">
      <!-- Sensores -->
      <div class="col-lg-6">
        <div class="card p-3 h-100">
          <h5 class="mb-3">Sensores</h5>

          <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-primary" onclick="loadSensors()">Ver sensores</button>
            <button class="btn btn-outline-light" onclick="downloadSensorsCSV()">Descargar CSV (sensores)</button>
          </div>

          <div class="table-responsive" style="max-height: 280px;">
            <table class="table table-sm align-middle" id="sensorsTable">
              <thead>
                <tr>
                  <th>ID</th><th>Nombre</th><th>Ubicación</th><th>Tipo</th><th>Unidad</th><th>Activo</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <hr/>
          <h6 class="mt-2">Añadir sensor</h6>
          <form id="addSensorForm" onsubmit="addSensor(event)" class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input class="form-control" required name="name" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Ubicación</label>
              <input class="form-control" required name="location" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Tipo de sensor</label>
              <input class="form-control" required name="sensor_type" placeholder="pH, Turbidez, etc." />
            </div>
            <div class="col-md-3">
              <label class="form-label">Unidad</label>
              <input class="form-control" required name="unit_name" placeholder="pH, NTU, °C..." />
            </div>
            <div class="col-md-3">
              <label class="form-label">Fecha instalación</label>
              <input class="form-control" type="date" name="installation_date" />
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="active" id="activeChk" checked />
                <label for="activeChk" class="form-check-label">Activo</label>
              </div>
            </div>
            <div class="col-12">
              <button class="btn btn-success" type="submit">Guardar sensor</button>
              <span id="addSensorMsg" class="ms-2"></span>
            </div>
          </form>
        </div>
      </div>

      <!-- Gráfica y datos -->
      <div class="col-lg-6">
        <div class="card p-3 h-100">
          <h5 class="mb-3">Mediciones</h5>
          <div class="row g-2 align-items-end">
            <div class="col-md-6">
              <label class="form-label">Sensor</label>
              <select id="sensorSelect" class="form-select"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Fecha (para reporte)</label>
              <input id="reportDate" type="date" class="form-control" />
            </div>
            <div class="col-md-3 d-grid">
              <button class="btn btn-primary" onclick="loadMeasurements()">Cargar mediciones</button>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 my-3">
            <button class="btn btn-outline-light" onclick="downloadChartPDF()">Descargar gráfica (PDF)</button>
            <button class="btn btn-outline-light" onclick="downloadServerReport()">Descargar reporte del backend (PDF)</button>
            <button class="btn btn-outline-light" onclick="downloadMeasurementsCSV()">Descargar CSV (mediciones)</button>
          </div>

          <canvas id="measureChart" height="140"></canvas>
          <div id="chartMsg" class="small mt-2"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Cambia esto si tu API está en otro host/puerto, p. ej.: "http://192.168.1.50:5000"
  function apiBase(){
    const base = document.getElementById('apiBase').value.trim();
    return base || '';
  }
  function api(path){
    return apiBase() + path;
  }

  let sensorsCache = [];
  let lastMeasurements = [];
  let chart;

  async function testAPI(){
    const el = document.getElementById('apiStatus');
    el.textContent = 'Comprobando...';
    fetch('http://192.168.100.158:5000/')
  .then(response=>{console.log(response)})  // convierte la respuesta a JSON
  .catch(error => {
    el.textcontext=error;
  });
  }

  async function loadSensors(){
    const tbody = document.querySelector('#sensorsTable tbody');
    tbody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
    try{
      const res = await fetch(api('/sensors'));
      if(!res.ok) throw new Error('Error al cargar sensores');
      sensorsCache = await res.json();
      tbody.innerHTML = '';
      const sel = document.getElementById('sensorSelect');
      sel.innerHTML = '';
      sensorsCache.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.id}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.location)}</td><td>${escapeHtml(s.sensor_type)}</td><td>${escapeHtml(s.unit_name)}</td><td>${s.active ? 'Sí' : 'No'}</td>`;
        tbody.appendChild(tr);
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = `${s.id} – ${s.name} (${s.location})`;
        sel.appendChild(opt);
      });
      if(sensorsCache.length===0){
        tbody.innerHTML = '<tr><td colspan="6">Sin sensores registrados</td></tr>';
      }
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="6">${err.message}</td></tr>`;
    }
  }

  async function addSensor(ev){
    ev.preventDefault();
    const f = ev.target;
    const payload = {
      name: f.name.value.trim(),
      location: f.location.value.trim(),
      sensor_type: f.sensor_type.value.trim(),
      unit_name: f.unit_name.value.trim(),
      installation_date: f.installation_date.value || null,
      active: !!f.active.checked
    };
    const msg = document.getElementById('addSensorMsg');
    msg.textContent = 'Guardando...';
    try{
      const res = await fetch(api('/sensors'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(t || 'Error al guardar');
      }
      msg.textContent = '✔️ Sensor creado';
      f.reset();
      document.getElementById('activeChk').checked = true;
      loadSensors();
    }catch(e){
      msg.textContent = '❌ ' + e.message;
    }
  }

  function downloadSensorsCSV(){
    if(!sensorsCache.length){
      return alert('Primero carga la lista de sensores');
    }
    const headers = ['id','name','location','sensor_type','unit_name','installation_date','active'];
    const rows = sensorsCache.map(s => [s.id,s.name,s.location,s.sensor_type,s.unit_name,s.installation_date || '', s.active]);
    const csv = [headers.join(','), ...rows.map(r => r.map(csvSafe).join(','))].join('\n');
    triggerDownload('sensores.csv', csv, 'text/csv');
  }

  async function loadMeasurements(){
    const id = document.getElementById('sensorSelect').value;
    if(!id){ return alert('Selecciona un sensor'); }
    const msg = document.getElementById('chartMsg');
    msg.textContent = 'Cargando mediciones...';
    try{
      const res = await fetch(api(`/measurements?sensor_id=${encodeURIComponent(id)}`));
      if(!res.ok) throw new Error('Error al cargar mediciones');
      lastMeasurements = await res.json();
      drawChart(lastMeasurements);
      msg.textContent = `Total mediciones: ${lastMeasurements.length}`;
    }catch(e){
      msg.textContent = '❌ ' + e.message;
    }
  }

  function drawChart(measurements){
    const ctx = document.getElementById('measureChart').getContext('2d');
    const labels = measurements.map(m => new Date(m.date_time));
    const values = measurements.map(m => m.value);
    const unit = measurements[0]?.unit || '';
    const sType = sensorsCache.find(s => s.id === measurements[0]?.sensor_id)?.sensor_type || 'Sensor';

    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: `${sType} [${unit}]`,
          data: values,
          borderWidth: 2,
          tension: .2,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { type: 'time', time: { unit: 'hour' } },
          y: { beginAtZero: false }
        },
        plugins: {
          legend: { labels: { color: '#cfe0ff' } }
        }
      }
    });
  }

  function downloadChartPDF(){
    if(!chart){ return alert('Primero genera la gráfica'); }
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
    const img = chart.toBase64Image();
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 36;
    const w = pageWidth - margin*2;
    const h = pageHeight - margin*2;
    pdf.setFontSize(18);
    pdf.text('Reporte de mediciones (cliente)', margin, margin - 8);
    pdf.addImage(img, 'PNG', margin, margin, w, h);
    pdf.save('grafica_mediciones.pdf');
  }

  function downloadServerReport(){
    const id = document.getElementById('sensorSelect').value;
    const date = document.getElementById('reportDate').value; // yyyy-mm-dd
    if(!id || !date){
      return alert('Selecciona un sensor y fecha para solicitar el PDF del backend');
    }
    // Backend espera MM/DD/YYYY
    const [yyyy,mm,dd] = date.split('-');
    const dateStr = `${mm}/${dd}/${yyyy}`;
    window.location.href = api(`/report?sensor_id=${encodeURIComponent(id)}&date=${encodeURIComponent(dateStr)}`);
  }

  function downloadMeasurementsCSV(){
    if(!lastMeasurements.length){
      return alert('Primero carga las mediciones');
    }
    const headers = ['id','sensor_id','date_time','value','unit'];
    const rows = lastMeasurements.map(m => [m.id,m.sensor_id,m.date_time,m.value,m.unit]);
    const csv = [headers.join(','), ...rows.map(r => r.map(csvSafe).join(','))].join('\n');
    triggerDownload('mediciones.csv', csv, 'text/csv');
  }

  // Helpers
  function triggerDownload(filename, data, mime){
    const blob = new Blob([data], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }
  function csvSafe(v){
    if(v==null) return '';
    const s = String(v);
    return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }

  // Cargar sensores al abrir
  document.addEventListener('DOMContentLoaded', loadSensors);
</script>
</body>
</html>

